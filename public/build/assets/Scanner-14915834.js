import{r as c,j as s,m as S,R as Y,B as q}from"./app-efec5667.js";import{e as L}from"./qr-scanner.min-ec314da7.js";import{P as H,a as J,I as Z,B as W,F as k}from"./PhoneNumberInput-637caec5.js";import"./index-a5b63327.js";function T({item:e}){const r=c.useMemo(()=>((e==null?void 0:e.newQty)??0)-((e==null?void 0:e.qty)??0),[e==null?void 0:e.newQty,e==null?void 0:e.qty]);return s.jsx(s.Fragment,{children:s.jsxs("tr",{className:"table-info",children:[s.jsx("td",{children:(e==null?void 0:e.display_name)??(e==null?void 0:e.name)}),s.jsxs("td",{children:[e==null?void 0:e.price," €"]}),s.jsx("td",{children:r}),s.jsxs("td",{children:[(e==null?void 0:e.price)*r," €"]})]})})}function ss({items:e=[],cartTotal:r=0,discount:l=0}){const y=c.useMemo(()=>r-l,[r,l]);return s.jsxs("div",{className:"h-100 d-flex flex-column justify-content-start",children:[s.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Cart Information"}),s.jsx("div",{className:"cart-info-items-container",children:s.jsx("div",{className:"card",children:s.jsxs("table",{className:"table mb-0 rounded",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Item"}),s.jsx("th",{children:"Price"}),s.jsx("th",{children:"Quantity"}),s.jsx("th",{children:"Total"})]})}),s.jsx("tbody",{children:e==null?void 0:e.map((u,n)=>u.newQty?s.jsx(T,{item:u},n):"")})]})})}),s.jsx("div",{className:"card mt-auto",children:s.jsx("table",{className:"table mb-0",children:s.jsxs("tbody",{children:[s.jsxs("tr",{children:[s.jsx("td",{children:"Subtotal"}),s.jsxs("td",{children:[r," €"]})]}),s.jsxs("tr",{children:[s.jsx("td",{children:"Discount"}),s.jsxs("td",{children:[l," €"]})]}),s.jsxs("tr",{children:[s.jsx("td",{children:"Total"}),s.jsxs("td",{children:[y," €"]})]})]})})})]})}const es=({open:e,onClose:r,ticket:l,handleSubmit:y,withdraw:u,setWithdraw:n})=>{const m=c.useMemo(()=>{var j;var t=0;return(j=l==null?void 0:l.extras)==null||j.map(i=>{(i==null?void 0:i.newQty)>0&&(t+=((i==null?void 0:i.newQty)-i.qty)*i.price)}),t},[l==null?void 0:l.extras]),[d,p]=c.useState({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"});c.useEffect(()=>{var t;(t=l==null?void 0:l.order_id)!=null&&t.billing&&p({name:l.order_id.billing.name||"",email:l.order_id.billing.email||"",phone:l.order_id.billing.phone||"",vatNumber:l.order_id.billing.vatNumber||"",discount:0,paymentMethod:"Cash"})},[l]);const x=t=>{const{name:j,value:i}=t.target;p(b=>({...b,[j]:i}))},[N,I]=c.useState(!1);c.useEffect(()=>{const t=document.getElementById("scannerPaymentModal");e?(t.classList.add("show","fade-in"),t.style.display="block"):(t.classList.remove("fade-in"),t.classList.add("fade-out"),setTimeout(()=>{t.style.display="none",t.classList.remove("show","fade-out")},300))},[e]);const g=()=>r(),M=async()=>{var i;I(!0);const t={biling:d,tickets:[],extras:(i=l==null?void 0:l.extras)==null?void 0:i.map(b=>{if(b.newQty>0)return{...b,quantity:b.newQty-b.qty}}),discount:d.discount,paymentMethod:d.paymentMethod,subTotal:m,total:m};(await S.post("https://events.essenciacompany.com/api/create-order",t,{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(y(),p({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"}),g()),I(!1)};return s.jsxs(s.Fragment,{children:[e&&s.jsx("div",{className:"payment-modal-backdrop payment-modal-fade-in"}),s.jsx("div",{className:`modal payment-modal ${e?"payment-modal-fade-in":"payment-modal-fade-out"}`,id:"scannerPaymentModal",tabIndex:"-1","aria-labelledby":"paymentModalLabel","aria-hidden":!e,onClick:g,children:s.jsx("div",{className:"modal-dialog modal-center modal-lg",onClick:t=>t.stopPropagation(),children:s.jsxs("div",{className:"modal-content p-0",children:[s.jsxs("div",{className:"modal-header",children:[s.jsx("h5",{className:"modal-title text-center",id:"paymentModalLabel",children:"Place Order"}),s.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:g})]}),s.jsxs("div",{className:"modal-body row",children:[s.jsxs("div",{className:"col-md-6",children:[s.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Payment Information"}),s.jsxs("div",{className:"form-group mb-2",children:[s.jsx("label",{htmlFor:"nameInput",children:"Name"}),s.jsx("input",{id:"nameInput",name:"name",className:"form-control",value:d.name,onChange:x,placeholder:"Enter name"})]}),s.jsxs("div",{className:"form-group mb-2",children:[s.jsxs("label",{htmlFor:"emailInput",children:["Email"," "]}),s.jsx("input",{id:"emailInput",className:"form-control",name:"email",value:d.email,onChange:x,placeholder:"Enter email"})]}),s.jsx(H,{value:d.phone,onChange:t=>p(j=>({...j,phone:"+"+t}))}),s.jsxs("div",{className:"form-group mb-2",children:[s.jsx("label",{htmlFor:"vatInput",children:"VAT Number (optional)"}),s.jsx("input",{id:"vatInput",className:"form-control",name:"vatNumber",value:d.vatNumber,onChange:x,placeholder:"Enter VAT number"})]}),s.jsxs("div",{className:"form-group row mb-4",children:[s.jsxs("div",{className:"col-md-4",children:[s.jsx("label",{htmlFor:"discountInput",children:"Payment Method"}),s.jsxs("select",{class:"form-select","aria-label":"Default select example",onChange:t=>p(j=>({...j,paymentMethod:t.target.value})),children:[s.jsx("option",{value:"Cash",selected:!0,children:"Cash"}),s.jsx("option",{value:"Card",children:"Card"})]})]}),s.jsxs("div",{className:"col-md-8",children:[s.jsx("label",{htmlFor:"discountInput",children:"Discount"}),s.jsx("input",{id:"discountInput",type:"number",className:"form-control",name:"discount",value:d.discount>0?d.discount:"",onChange:x,placeholder:"Enter discount"})]})]}),s.jsxs("div",{className:"form-check",children:[s.jsx("input",{className:"form-check-input",type:"checkbox",value:"",id:"flexCheckDefault",checked:u,onChange:()=>n(!u)}),s.jsx("label",{className:"form-check-label",for:"flexCheckDefault",children:"Withdraw"})]})]}),s.jsx("div",{className:"col-md-6",children:s.jsx(ss,{items:l==null?void 0:l.extras,cartTotal:m,discount:d.discount})})]}),s.jsxs("div",{className:"modal-footer",children:[s.jsx("button",{type:"button",className:"btn btn-secondary",onClick:g,children:"Close"}),s.jsx("button",{type:"button",className:"btn btn-primary",onClick:M,disabled:!d.name||(d.vatNumber?!(d.email||d.phone):!1)||N,children:N?"Processing...":"Proceed"})]})]})})})]})},ns=({extra:e,index:r,handleExtraChange:l})=>{const[y,u]=c.useState(0),n=parseInt((e==null?void 0:e.newQty)??0)||parseInt((e==null?void 0:e.qty)??0),m=parseFloat((e==null?void 0:e.price)??0).toFixed(2),d=x=>{const N=parseInt(x.target.value)||0;u(N)},p=()=>{y>0&&y<=e.qty-e.used&&(l(e,y),u(0))};return s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body text-start",children:[s.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[s.jsxs("p",{className:"h6",children:[(e==null?void 0:e.display_name)??(e==null?void 0:e.name)," X ",n-(e==null?void 0:e.used),e!=null&&e.newQty?s.jsxs("sup",{className:"text-secondary fs-6",children:["+ ",(e==null?void 0:e.newQty)-(e==null?void 0:e.qty)]}):""]}),s.jsxs("h6",{children:["€"," ",(m*parseInt(e!=null&&e.newQty?(e==null?void 0:e.newQty)-(e==null?void 0:e.qty):0)).toFixed(2)]})]}),s.jsxs("div",{className:"mt-3",children:[s.jsxs("label",{htmlFor:"",children:["Withdraw (Available: ",(e==null?void 0:e.qty)-(e==null?void 0:e.used),")"]}),s.jsxs("div",{className:"form-inline d-flex gap-2",children:[s.jsx("input",{type:"number",min:1,max:(e==null?void 0:e.qty)-(e==null?void 0:e.used),value:y,onChange:d,className:"form-control"}),s.jsx("button",{className:"btn btn-sm btn-dark",onClick:p,children:s.jsx("i",{className:"fa fa-check"})})]})]})]})},r)},hs=()=>{var $,A;const e=Y.useRef(null),[r,l]=c.useState(null),[y,u]=c.useState(!1),[n,m]=c.useState(null),[d,p]=c.useState(""),[x,N]=c.useState(!1),[I,g]=c.useState(!1),[M,t]=c.useState(!1);c.useEffect(()=>{if(e.current&&!r){const a=new L(e.current,o=>{i(o)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(a)}return()=>{r&&(r.stop(),r.destroy(),l(null))}},[e.current,r]);const j=()=>{r?(u(!0),N(!0),r.start()):console.error("Scanner is not initialized yet")},i=async a=>{if(a!=null&&a.data)try{const o=await S.post("https://events.essenciacompany.com/api/tickets/get",{ticket:a==null?void 0:a.data});m(o.data)}catch(o){q("Error scanning ticket",o)}},b=a=>{a.key==="Enter"&&B()},B=async()=>{if(d){g(!1),u(!1);try{const a=await S.post("https://events.essenciacompany.com/api/tickets/get",{ticket:d});m(a.data),p("")}catch(a){q("Error scanning ticket",a)}finally{setIsProcessing(!1)}}},U=(a,o)=>{const f=parseInt(a==null?void 0:a.used)??0;if(o=parseInt(o),o>a.qty-(a==null?void 0:a.used))return;a={...a,used:o+f};var C=n.extras.map(K=>K.id===a.id?a:K);let h=n;h.extras=C,m(h),console.log(n),R()},{data:w,isError:as,isLoading:ls,isSuccess:ts,refetch:os}=J(["scanner-extras",n],`https://events.essenciacompany.com/api/event-extras/${n==null?void 0:n.event_id}`),[E,_]=c.useState(!1),[v,D]=c.useState(null),[P,F]=c.useState(1),V=()=>{var C;if(!E){_(!0);return}const a={...v,qty:0,newQty:P};var o=!0,f=(C=n==null?void 0:n.extras)==null?void 0:C.map(h=>(console.log(h),h.id===a.id?(o=!1,{...h,newQty:parseInt(a.newQty)+parseInt((h==null?void 0:h.newQty)??(h==null?void 0:h.qty)??0)}):h));o&&(f=[...f,a]),m(h=>({...h,extras:[...f]})),_(!1),D(null),F(1)},[X,Q]=c.useState(!1),R=async()=>{if(Q(!0),(await S.post("https://events.essenciacompany.com/api/update-ticket",{ticket:n,can_withdraw:M},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(m(null),u(!1),t(!1),q("Ticket updated successfully!!"),r)){r.stop();const o=new L(e.current,f=>{i(f)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(o),o.start()}Q(!1)},z=async()=>{var o;Q(!0);const a=await S.post("https://events.essenciacompany.com/api/tickets/activate",{ticket:n==null?void 0:n.id},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}});a.status==200&&(m((o=a==null?void 0:a.data)==null?void 0:o.ticket),q("Ticket activated successfully!!")),Q(!1)},[G,O]=c.useState(!1);return s.jsxs("section",{className:"scanner-page",children:[n?s.jsxs("div",{className:"ticket-info",children:[s.jsx("h3",{children:"Ticket Information"}),s.jsxs("div",{className:"ticket-details",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Owner:"})," ",n==null?void 0:n.owner.name]}),(n==null?void 0:n.owner.email)&&s.jsxs("p",{children:[s.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.owner.email]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Event:"})," ",n==null?void 0:n.event_name]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Ticket:"})," ",n==null?void 0:n.product_name]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Price:"})," €",n==null?void 0:n.price]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Status:"})," ",(n==null?void 0:n.status)===0?"Not Used":"Used"]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Dates:"})," ",n==null?void 0:n.dates.join(", ")]}),s.jsx("p",{children:s.jsxs("strong",{children:[(n==null?void 0:n.active)===0&&"Not ","Active",(n==null?void 0:n.active)===0&&s.jsx("span",{className:"btn btn-success ms-3 py-1 px-2",onClick:z,children:"Activate"})]})})]}),(($=n==null?void 0:n.extras)==null?void 0:$.length)>0?s.jsxs("div",{className:"extras",children:[s.jsx("h4",{children:"Extras"}),n==null?void 0:n.extras.map((a,o)=>s.jsx(ns,{extra:a,index:o,handleExtraChange:U}))]}):null,E&&s.jsx("div",{className:"modal-body row",children:s.jsxs("div",{className:"col-md-12",children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{htmlFor:"extraSelect",children:"Select Extra"}),s.jsxs("select",{id:"extraSelect",className:"form-control mt-2",value:(v==null?void 0:v.display_name)||"",onChange:a=>{var f;const o=(f=w==null?void 0:w.data)==null?void 0:f.find(C=>C.display_name===a.target.value);D(o||null)},children:[s.jsx("option",{value:"",children:"None"}),(A=w==null?void 0:w.data)==null?void 0:A.map((a,o)=>s.jsx("option",{value:a==null?void 0:a.display_name,children:a==null?void 0:a.display_name},o))]})]}),v&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"form-group mt-3 d-flex flex-column justify-content-center align-items-center",children:[s.jsx("label",{htmlFor:"quantity",children:"Quantity"}),s.jsxs(Z,{className:"w-50",children:[s.jsx(W,{variant:"outline-secondary",onClick:()=>F(a=>a-1>0?a-1:a),children:"-"}),s.jsx(k.Control,{"aria-label":"Example text with two button addons",className:"text-center",readOnly:!0,value:P}),s.jsx(W,{variant:"outline-danger",onClick:()=>F(a=>a+1),children:"+"})]})]}),s.jsxs("label",{htmlFor:"price",children:["Price",s.jsx("br",{}),(v==null?void 0:v.price)*P,"€"]})]})]})}),s.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:s.jsx("button",{type:"button",class:"btn btn-info text-light w-100 py-1",onClick:V,children:"Add extra"})}),s.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:s.jsx("button",{type:"button",class:"btn btn-success text-light w-100 py-1",onClick:()=>O(!0),children:X?"Processing...":"Save Changes"})})]}):y?"":s.jsxs("div",{className:"d-flex flex-column align-items-center gap-3",children:[s.jsxs("div",{className:"qr-box flex-column",onClick:j,children:[s.jsx("img",{className:"qr-image",src:"/assets/qr-code.png",alt:"QR Code"}),s.jsx("h3",{children:"start scanning"})]}),s.jsx("h3",{children:"or"}),s.jsx("input",{className:"qr-box flex-column",type:"text",onChange:a=>p(a.target.value),onKeyDown:b,placeholder:"Manually enter ticket code"})]}),!n&&s.jsxs("div",{children:[s.jsx("div",{id:"viewfinder",className:"qr-box",style:x?{}:{display:"none"},children:s.jsx("video",{ref:e,children:"Your browser does not support video playback."})}),s.jsx("div",{id:"manual-input",className:"form-group",style:I?{}:{display:"none"},children:s.jsx("input",{type:"text",name:"manual",className:"form-control",id:"manual",value:d,onChange:a=>p(a.target.value),onKeyDown:b,placeholder:"Enter ticket code manually"})})]}),s.jsx(es,{open:G,onClose:()=>O(!1),ticket:n,handleSubmit:R,withdraw:M,setWithdraw:t})]})};export{hs as default};
