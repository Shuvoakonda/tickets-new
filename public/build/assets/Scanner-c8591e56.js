import{R as X,r,m as f,B as x,b as z,u as G,j as e,s as Y}from"./app-437d36fd.js";import{e as H}from"./qr-scanner.min-b9558d23.js";import{a as J,I as W,B as E,F as Z}from"./useFetch-081bd057.js";import"./index-b7f82cc9.js";const rs=()=>{var Q,q;const h=X.useRef(null),[i,g]=r.useState(null),[F,v]=r.useState(!1),[n,u]=r.useState(null),[p,b]=r.useState(""),[I,_]=r.useState(!1),[P,R]=r.useState(!1);r.useEffect(()=>{if(h.current&&!i){const s=new H(h.current,l=>{O(l)},{highlightScanRegion:!0,highlightCodeOutline:!0});g(s)}return()=>{i&&(i.stop(),i.destroy(),g(null))}},[h.current,i]);const M=()=>{i?(v(!0),_(!0),i.start()):console.error("Scanner is not initialized yet")},O=async s=>{if(s!=null&&s.data)try{const l=await f.post("https://events.essenciacompany.com/api/tickets/get",{ticket:s==null?void 0:s.data});u(l.data)}catch(l){x("Error scanning ticket",l)}},$=s=>{s.key==="Enter"&&A()},A=async()=>{if(p){R(!1),v(!1);try{const s=await f.post("https://events.essenciacompany.com/api/tickets/get",{ticket:p});u(s.data),b("")}catch(s){x("Error scanning ticket",s)}finally{setIsProcessing(!1)}}},m=(s,l)=>{const t=parseInt(s==null?void 0:s.qty)??0;if(l=parseInt(l),!(l<t)){s={...s,newQty:l};var c=n.extras.map(a=>a.id===s.id?s:a);u(a=>({...a,extras:[...c]}))}},{data:d,isError:L,isLoading:T,isSuccess:ss,refetch:es}=J(["scanner-extras",n],`https://events.essenciacompany.com/api/event-extras/${n==null?void 0:n.event_id}`),[N,S]=r.useState(!1),[o,w]=r.useState(null),[j,y]=r.useState(1),B=()=>{var c;if(!N){S(!0);return}const s={...o,qty:0,newQty:j};var l=!0,t=(c=n==null?void 0:n.extras)==null?void 0:c.map(a=>a.id===s.id?(l=!1,{...a,newQty:s.newQty+((a==null?void 0:a.newQty)??(a==null?void 0:a.qty)??0)}):a);l&&(t=[...t,s]),u(a=>({...a,extras:[...t]})),S(!1),w(null),y(1)},[D,C]=r.useState(!1),{addItem:K}=z(),U=G(),k=async()=>{var l;var s=(l=n==null?void 0:n.extras)==null?void 0:l.map(t=>{if((t==null?void 0:t.newQty)>0)return{...t,qty:(t==null?void 0:t.newQty)-((t==null?void 0:t.qty)??0)}});s!=null&&s.length&&(s.forEach(t=>{K(t,t==null?void 0:t.qty)}),U(Y(!0)))},V=async()=>{var l;C(!0);const s=await f.post("https://events.essenciacompany.com/api/tickets/activate",{ticket:n==null?void 0:n.id},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}});s.status==200&&(u((l=s==null?void 0:s.data)==null?void 0:l.ticket),x("Ticket activated successfully!!")),C(!1)};return e.jsxs("section",{className:"scanner-page",children:[n?e.jsxs("div",{className:"ticket-info",children:[e.jsx("h3",{children:"Ticket Information"}),e.jsxs("div",{className:"ticket-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Owner:"})," ",n==null?void 0:n.owner.name]}),(n==null?void 0:n.owner.email)&&e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.owner.email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Event:"})," ",n==null?void 0:n.event_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ticket:"})," ",n==null?void 0:n.product_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Price:"})," €",n==null?void 0:n.price]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",(n==null?void 0:n.status)===0?"Not Used":"Used"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Dates:"})," ",n==null?void 0:n.dates.join(", ")]}),e.jsx("p",{children:e.jsxs("strong",{children:[(n==null?void 0:n.active)===0&&"Not ","Active",(n==null?void 0:n.active)===0&&e.jsx("span",{className:"btn btn-success ms-3 py-1 px-2",onClick:V,children:"Activate"})]})})]}),((Q=n==null?void 0:n.extras)==null?void 0:Q.length)>0?e.jsxs("div",{className:"extras",children:[e.jsx("h4",{children:"Extras"}),e.jsx("ul",{children:n==null?void 0:n.extras.map((s,l)=>{const t=parseInt((s==null?void 0:s.newQty)??(s==null?void 0:s.qty)??0),c=parseFloat((s==null?void 0:s.price)??0).toFixed(2);return e.jsxs("span",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{className:"col-md-3 text-start",children:s==null?void 0:s.display_name}),e.jsxs("div",{className:"update-quantity d-flex align-items-center justify-content-center col-md-3",children:[e.jsx("button",{className:"btn btn-outline-danger btn-sm",onClick:()=>m(s,t-1),children:"-"}),e.jsx("input",{type:"number",value:t,onChange:a=>m(s,a.target.value),className:"form-control text-center mx-2 border-0",style:{width:"40px"}}),e.jsx("button",{className:"btn btn-outline-dark btn-sm",onClick:()=>m(s,t+1),children:"+"})]}),e.jsxs("span",{className:"col-md-3 text-end",children:["X ",c,"€ ="]}),e.jsxs("span",{className:"col-md-3 text-end",children:[c*parseInt(s!=null&&s.newQty?(s==null?void 0:s.newQty)-(s==null?void 0:s.qty):0),"€"]})]},l)})})]}):null,N&&e.jsx("div",{className:"modal-body row",children:e.jsxs("div",{className:"col-md-12",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"extraSelect",children:"Select Extra"}),e.jsxs("select",{id:"extraSelect",className:"form-control mt-2",value:(o==null?void 0:o.display_name)||"",onChange:s=>{var t;const l=(t=d==null?void 0:d.data)==null?void 0:t.find(c=>c.display_name===s.target.value);w(l||null)},children:[e.jsx("option",{value:"",children:"None"}),(q=d==null?void 0:d.data)==null?void 0:q.map((s,l)=>e.jsx("option",{value:s==null?void 0:s.display_name,children:s==null?void 0:s.display_name},l))]})]}),o&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group mt-3 d-flex flex-column justify-content-center align-items-center",children:[e.jsx("label",{htmlFor:"quantity",children:"Quantity"}),e.jsxs(W,{className:"w-50",children:[e.jsx(E,{variant:"outline-secondary",onClick:()=>y(s=>s-1>0?s-1:s),children:"-"}),e.jsx(Z.Control,{"aria-label":"Example text with two button addons",className:"text-center",readOnly:!0,value:j}),e.jsx(E,{variant:"outline-danger",onClick:()=>y(s=>s+1),children:"+"})]})]}),e.jsxs("label",{htmlFor:"price",children:["Price",e.jsx("br",{}),(o==null?void 0:o.price)*j,"€"]})]})]})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-info text-light w-100 py-1",onClick:B,children:"Add extra"})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-success text-light w-100 py-1",onClick:k,children:D?"Processing...":"Save Changes"})})]}):F?"":e.jsxs("div",{className:"d-flex gap-3",children:[e.jsxs("div",{className:"qr-box flex-column",onClick:M,children:[e.jsx("img",{className:"qr-image",src:"/assets/qr-code.png",alt:"QR Code"}),e.jsx("h3",{children:"start scanning"})]}),e.jsxs("div",{className:"qr-box flex-column",onClick:handleStartManual,children:[e.jsx("img",{className:"qr-image",src:"/assets/keyboard.svg",alt:"keyboard"}),e.jsx("h3",{children:"Enter manually"})]})]}),!n&&e.jsxs("div",{children:[e.jsx("div",{id:"viewfinder",className:"qr-box",style:I?{}:{display:"none"},children:e.jsx("video",{ref:h,children:"Your browser does not support video playback."})}),e.jsx("div",{id:"manual-input",className:"form-group",style:P?{}:{display:"none"},children:e.jsx("input",{type:"text",name:"manual",className:"form-control",id:"manual",value:p,onChange:s=>b(s.target.value),onKeyDown:$,placeholder:"Enter ticket code manually"})})]})]})};export{rs as default};
