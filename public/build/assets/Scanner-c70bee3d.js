import{r as c,j as s,m as C,R as H,B as Q}from"./app-19cced2d.js";import{e as B}from"./qr-scanner.min-7ae0a142.js";import{P as J,a as W,I as Z,B as V,F as T}from"./PhoneNumberInput-4c824464.js";import"./index-2f0c38c5.js";function k({item:a}){const o=c.useMemo(()=>((a==null?void 0:a.newQty)??0)-((a==null?void 0:a.qty)??0),[a==null?void 0:a.newQty,a==null?void 0:a.qty]);return s.jsx(s.Fragment,{children:s.jsxs("tr",{className:"table-info",children:[s.jsx("td",{children:(a==null?void 0:a.display_name)??(a==null?void 0:a.name)}),s.jsxs("td",{children:[a==null?void 0:a.price," €"]}),s.jsx("td",{children:o}),s.jsxs("td",{children:[(a==null?void 0:a.price)*o," €"]})]})})}function ss({items:a=[],cartTotal:o=0,discount:l=0}){const N=c.useMemo(()=>o-l,[o,l]);return s.jsxs("div",{className:"h-100 d-flex flex-column justify-content-start",children:[s.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Cart Information"}),s.jsx("div",{className:"cart-info-items-container",children:s.jsx("div",{className:"card",children:s.jsxs("table",{className:"table mb-0 rounded",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{children:"Item"}),s.jsx("th",{children:"Price"}),s.jsx("th",{children:"Quantity"}),s.jsx("th",{children:"Total"})]})}),s.jsx("tbody",{children:a==null?void 0:a.map((u,n)=>u.newQty?s.jsx(k,{item:u},n):"")})]})})}),s.jsx("div",{className:"card mt-auto",children:s.jsx("table",{className:"table mb-0",children:s.jsxs("tbody",{children:[s.jsxs("tr",{children:[s.jsx("td",{children:"Subtotal"}),s.jsxs("td",{children:[o," €"]})]}),s.jsxs("tr",{children:[s.jsx("td",{children:"Discount"}),s.jsxs("td",{children:[l," €"]})]}),s.jsxs("tr",{children:[s.jsx("td",{children:"Total"}),s.jsxs("td",{children:[N," €"]})]})]})})})]})}const es=({open:a,onClose:o,ticket:l,handleSubmit:N})=>{var E,M,w,S,P,j,_,D;const u=c.useMemo(()=>{var m;var t=0;return(m=l==null?void 0:l.extras)==null||m.map(d=>{(d==null?void 0:d.newQty)>0&&(t+=((d==null?void 0:d.newQty)-d.qty)*d.price)}),t},[l==null?void 0:l.extras]),[n,h]=c.useState({name:(M=(E=l==null?void 0:l.order_id)==null?void 0:E.billing)==null?void 0:M.name,email:(S=(w=l==null?void 0:l.order_id)==null?void 0:w.billing)==null?void 0:S.email,phone:(j=(P=l==null?void 0:l.order_id)==null?void 0:P.billing)==null?void 0:j.phone,vatNumber:(D=(_=l==null?void 0:l.order_id)==null?void 0:_.billing)==null?void 0:D.vatNumber,discount:0,paymentMethod:"Cash"}),x=t=>{const{name:m,value:d}=t.target;h(y=>({...y,[m]:d}))},[g,I]=c.useState(!1);c.useEffect(()=>{const t=document.getElementById("scannerPaymentModal");a?(t.classList.add("show","fade-in"),t.style.display="block"):(t.classList.remove("fade-in"),t.classList.add("fade-out"),setTimeout(()=>{t.style.display="none",t.classList.remove("show","fade-out")},300))},[a]);const v=()=>o(),F=async()=>{var d;I(!0);const t={biling:n,tickets:[],extras:(d=l==null?void 0:l.extras)==null?void 0:d.map(y=>{if(y.newQty>0)return{...y,quantity:y.newQty-y.qty}}),discount:n.discount,paymentMethod:n.paymentMethod,subTotal:u,total:u};(await C.post("https://events.essenciacompany.com/api/create-order",t,{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(N(),h({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"}),v()),I(!1)};return s.jsxs(s.Fragment,{children:[a&&s.jsx("div",{className:"payment-modal-backdrop payment-modal-fade-in"}),s.jsx("div",{className:`modal payment-modal ${a?"payment-modal-fade-in":"payment-modal-fade-out"}`,id:"scannerPaymentModal",tabIndex:"-1","aria-labelledby":"paymentModalLabel","aria-hidden":!a,onClick:v,children:s.jsx("div",{className:"modal-dialog modal-center modal-lg",onClick:t=>t.stopPropagation(),children:s.jsxs("div",{className:"modal-content p-0",children:[s.jsxs("div",{className:"modal-header",children:[s.jsx("h5",{className:"modal-title text-center",id:"paymentModalLabel",children:"Place Order"}),s.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:v})]}),s.jsxs("div",{className:"modal-body row",children:[s.jsxs("div",{className:"col-md-6",children:[s.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Payment Information"}),s.jsxs("div",{className:"form-group mb-2",children:[s.jsx("label",{htmlFor:"nameInput",children:"Name"}),s.jsx("input",{id:"nameInput",name:"name",className:"form-control",value:n.name,onChange:x,placeholder:"Enter name"})]}),s.jsxs("div",{className:"form-group mb-2",children:[s.jsxs("label",{htmlFor:"emailInput",children:["Email"," "]}),s.jsx("input",{id:"emailInput",className:"form-control",name:"email",value:n.email,onChange:x,placeholder:"Enter email"})]}),s.jsx(J,{value:n.phone,onChange:t=>h(m=>({...m,phone:"+"+t}))}),s.jsxs("div",{className:"form-group mb-2",children:[s.jsx("label",{htmlFor:"vatInput",children:"VAT Number (optional)"}),s.jsx("input",{id:"vatInput",className:"form-control",name:"vatNumber",value:n.vatNumber,onChange:x,placeholder:"Enter VAT number"})]}),s.jsxs("div",{className:"form-group row mb-4",children:[s.jsxs("div",{className:"col-md-4",children:[s.jsx("label",{htmlFor:"discountInput",children:"Payment Method"}),s.jsxs("select",{class:"form-select","aria-label":"Default select example",onChange:t=>h(m=>({...m,paymentMethod:t.target.value})),children:[s.jsx("option",{value:"Cash",selected:!0,children:"Cash"}),s.jsx("option",{value:"Card",children:"Card"})]})]}),s.jsxs("div",{className:"col-md-8",children:[s.jsx("label",{htmlFor:"discountInput",children:"Discount"}),s.jsx("input",{id:"discountInput",type:"number",className:"form-control",name:"discount",value:n.discount>0?n.discount:"",onChange:x,placeholder:"Enter discount"})]})]})]}),s.jsx("div",{className:"col-md-6",children:s.jsx(ss,{items:l==null?void 0:l.extras,cartTotal:u,discount:n.discount})})]}),s.jsxs("div",{className:"modal-footer",children:[s.jsx("button",{type:"button",className:"btn btn-secondary",onClick:v,children:"Close"}),s.jsx("button",{type:"button",className:"btn btn-primary",onClick:F,disabled:!n.name||(n.vatNumber?!(n.email||n.phone):!1)||g,children:g?"Processing...":"Proceed"})]})]})})})]})},rs=()=>{var K,L;const a=H.useRef(null),[o,l]=c.useState(null),[N,u]=c.useState(!1),[n,h]=c.useState(null),[x,g]=c.useState(""),[I,v]=c.useState(!1),[F,E]=c.useState(!1);c.useEffect(()=>{if(a.current&&!o){const e=new B(a.current,r=>{w(r)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(e)}return()=>{o&&(o.stop(),o.destroy(),l(null))}},[a.current,o]);const M=()=>{o?(u(!0),v(!0),o.start()):console.error("Scanner is not initialized yet")},w=async e=>{if(e!=null&&e.data)try{const r=await C.post("https://events.essenciacompany.com/api/tickets/get",{ticket:e==null?void 0:e.data});h(r.data)}catch(r){Q("Error scanning ticket",r)}},S=e=>{e.key==="Enter"&&P()},P=async()=>{if(x){E(!1),u(!1);try{const e=await C.post("https://events.essenciacompany.com/api/tickets/get",{ticket:x});h(e.data),g("")}catch(e){Q("Error scanning ticket",e)}finally{setIsProcessing(!1)}}},{data:j,isError:_,isLoading:D,isSuccess:t,refetch:m}=W(["scanner-extras",n],`https://events.essenciacompany.com/api/event-extras/${n==null?void 0:n.event_id}`),[d,y]=c.useState(!1),[f,$]=c.useState(null),[R,O]=c.useState(1),X=()=>{var b;if(!d){y(!0);return}const e={...f,qty:0,newQty:R};var r=!0,p=(b=n==null?void 0:n.extras)==null?void 0:b.map(i=>i.id===e.id?(r=!1,{...i,newQty:parseInt(e.newQty)+parseInt((i==null?void 0:i.newQty)??(i==null?void 0:i.qty)??0)}):i);r&&(p=[...p,e]),h(i=>({...i,extras:[...p]})),y(!1),$(null),O(1)},[U,q]=c.useState(!1),z=async()=>{if(q(!0),(await C.post("https://events.essenciacompany.com/api/update-ticket",{ticket:n},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(h(null),u(!1),Q("Ticket updated successfully!!"),o)){o.stop();const r=new B(a.current,p=>{w(p)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(r),r.start()}q(!1)},G=async()=>{var r;q(!0);const e=await C.post("https://events.essenciacompany.com/api/tickets/activate",{ticket:n==null?void 0:n.id},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}});e.status==200&&(h((r=e==null?void 0:e.data)==null?void 0:r.ticket),Q("Ticket activated successfully!!")),q(!1)},[Y,A]=c.useState(!1);return s.jsxs("section",{className:"scanner-page",children:[n?s.jsxs("div",{className:"ticket-info",children:[s.jsx("h3",{children:"Ticket Information"}),s.jsxs("div",{className:"ticket-details",children:[s.jsxs("p",{children:[s.jsx("strong",{children:"Owner:"})," ",n==null?void 0:n.owner.name]}),(n==null?void 0:n.owner.email)&&s.jsxs("p",{children:[s.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.owner.email]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Event:"})," ",n==null?void 0:n.event_name]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Ticket:"})," ",n==null?void 0:n.product_name]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Price:"})," €",n==null?void 0:n.price]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Status:"})," ",(n==null?void 0:n.status)===0?"Not Used":"Used"]}),s.jsxs("p",{children:[s.jsx("strong",{children:"Dates:"})," ",n==null?void 0:n.dates.join(", ")]}),s.jsx("p",{children:s.jsxs("strong",{children:[(n==null?void 0:n.active)===0&&"Not ","Active",(n==null?void 0:n.active)===0&&s.jsx("span",{className:"btn btn-success ms-3 py-1 px-2",onClick:G,children:"Activate"})]})})]}),((K=n==null?void 0:n.extras)==null?void 0:K.length)>0?s.jsxs("div",{className:"extras",children:[s.jsx("h4",{children:"Extras"}),s.jsx("ul",{children:n==null?void 0:n.extras.map((e,r)=>{const p=parseInt((e==null?void 0:e.newQty)??0)?parseInt((e==null?void 0:e.newQty)??0)-parseInt((e==null?void 0:e.qty)??0):parseInt((e==null?void 0:e.qty)??0),b=parseFloat((e==null?void 0:e.price)??0).toFixed(2);return s.jsxs("span",{className:"d-flex justify-content-between align-items-center",children:[s.jsx("span",{className:"col-md-3 text-start",children:(e==null?void 0:e.display_name)??(e==null?void 0:e.name)}),s.jsxs("span",{className:"col-md-3 text-end",children:[p," X ",b,"€ ="]}),s.jsxs("span",{className:"col-md-3 text-end",children:[b*parseInt(e!=null&&e.newQty?(e==null?void 0:e.newQty)-(e==null?void 0:e.qty):0),"€"]})]},r)})})]}):null,d&&s.jsx("div",{className:"modal-body row",children:s.jsxs("div",{className:"col-md-12",children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{htmlFor:"extraSelect",children:"Select Extra"}),s.jsxs("select",{id:"extraSelect",className:"form-control mt-2",value:(f==null?void 0:f.display_name)||"",onChange:e=>{var p;const r=(p=j==null?void 0:j.data)==null?void 0:p.find(b=>b.display_name===e.target.value);$(r||null)},children:[s.jsx("option",{value:"",children:"None"}),(L=j==null?void 0:j.data)==null?void 0:L.map((e,r)=>s.jsx("option",{value:e==null?void 0:e.display_name,children:e==null?void 0:e.display_name},r))]})]}),f&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"form-group mt-3 d-flex flex-column justify-content-center align-items-center",children:[s.jsx("label",{htmlFor:"quantity",children:"Quantity"}),s.jsxs(Z,{className:"w-50",children:[s.jsx(V,{variant:"outline-secondary",onClick:()=>O(e=>e-1>0?e-1:e),children:"-"}),s.jsx(T.Control,{"aria-label":"Example text with two button addons",className:"text-center",readOnly:!0,value:R}),s.jsx(V,{variant:"outline-danger",onClick:()=>O(e=>e+1),children:"+"})]})]}),s.jsxs("label",{htmlFor:"price",children:["Price",s.jsx("br",{}),(f==null?void 0:f.price)*R,"€"]})]})]})}),s.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:s.jsx("button",{type:"button",class:"btn btn-info text-light w-100 py-1",onClick:X,children:"Add extra"})}),s.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:s.jsx("button",{type:"button",class:"btn btn-success text-light w-100 py-1",onClick:()=>A(!0),children:U?"Processing...":"Save Changes"})})]}):N?"":s.jsxs("div",{className:"d-flex flex-column align-items-center gap-3",children:[s.jsxs("div",{className:"qr-box flex-column",onClick:M,children:[s.jsx("img",{className:"qr-image",src:"/assets/qr-code.png",alt:"QR Code"}),s.jsx("h3",{children:"start scanning"})]}),s.jsx("h3",{children:"or"}),s.jsx("input",{className:"qr-box flex-column",type:"text",onChange:e=>g(e.target.value),onKeyDown:S,placeholder:"Manually enter ticket code"})]}),!n&&s.jsxs("div",{children:[s.jsx("div",{id:"viewfinder",className:"qr-box",style:I?{}:{display:"none"},children:s.jsx("video",{ref:a,children:"Your browser does not support video playback."})}),s.jsx("div",{id:"manual-input",className:"form-group",style:F?{}:{display:"none"},children:s.jsx("input",{type:"text",name:"manual",className:"form-control",id:"manual",value:x,onChange:e=>g(e.target.value),onKeyDown:S,placeholder:"Enter ticket code manually"})})]}),s.jsx(es,{open:Y,onClose:()=>A(!1),ticket:n,handleSubmit:z})]})};export{rs as default};
