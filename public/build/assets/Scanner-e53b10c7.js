import{r as o,j as e,m as C,R as z,B as P}from"./app-d8f4b848.js";import{e as A}from"./qr-scanner.min-7c2a769f.js";import{P as G,a as Y,I as H,B as K,F as J}from"./PhoneNumberInput-660713c9.js";import"./index-0216e1f0.js";function Z({item:a}){const c=o.useMemo(()=>((a==null?void 0:a.newQty)??0)-((a==null?void 0:a.qty)??0),[a==null?void 0:a.newQty,a==null?void 0:a.qty]);return e.jsx(e.Fragment,{children:e.jsxs("tr",{className:"table-info",children:[e.jsx("td",{children:(a==null?void 0:a.display_name)??(a==null?void 0:a.name)}),e.jsxs("td",{children:[a==null?void 0:a.price," €"]}),e.jsx("td",{children:c}),e.jsxs("td",{children:[(a==null?void 0:a.price)*c," €"]})]})})}function k({items:a=[],cartTotal:c=0,discount:l=0}){const w=o.useMemo(()=>c-l,[c,l]);return e.jsxs("div",{className:"h-100 d-flex flex-column justify-content-start",children:[e.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Cart Information"}),e.jsx("div",{className:"cart-info-items-container",children:e.jsx("div",{className:"card",children:e.jsxs("table",{className:"table mb-0 rounded",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Total"})]})}),e.jsx("tbody",{children:a==null?void 0:a.map((p,n)=>p.newQty?e.jsx(Z,{item:p},n):"")})]})})}),e.jsx("div",{className:"card mt-auto",children:e.jsx("table",{className:"table mb-0",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"Subtotal"}),e.jsxs("td",{children:[c," €"]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Discount"}),e.jsxs("td",{children:[l," €"]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Total"}),e.jsxs("td",{children:[w," €"]})]})]})})})]})}const T=({open:a,onClose:c,ticket:l,handleSubmit:w,withdraw:p,setWithdraw:n})=>{const j=o.useMemo(()=>{var u;var t=0;return(u=l==null?void 0:l.extras)==null||u.map(i=>{(i==null?void 0:i.newQty)>0&&(t+=((i==null?void 0:i.newQty)-i.qty)*i.price)}),t},[l==null?void 0:l.extras]),[d,x]=o.useState({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"});o.useEffect(()=>{var t;(t=l==null?void 0:l.order_id)!=null&&t.billing&&x({name:l.order_id.billing.name||"",email:l.order_id.billing.email||"",phone:l.order_id.billing.phone||"",vatNumber:l.order_id.billing.vatNumber||"",discount:0,paymentMethod:"Cash"})},[l]);const g=t=>{const{name:u,value:i}=t.target;x(y=>({...y,[u]:i}))},[S,I]=o.useState(!1);o.useEffect(()=>{const t=document.getElementById("scannerPaymentModal");a?(t.classList.add("show","fade-in"),t.style.display="block"):(t.classList.remove("fade-in"),t.classList.add("fade-out"),setTimeout(()=>{t.style.display="none",t.classList.remove("show","fade-out")},300))},[a]);const v=()=>c(),E=async()=>{var i;I(!0);const t={biling:d,tickets:[],extras:(i=l==null?void 0:l.extras)==null?void 0:i.map(y=>{if(y.newQty>0)return{...y,quantity:y.newQty-y.qty}}),discount:d.discount,paymentMethod:d.paymentMethod,subTotal:j,total:j};(await C.post("https://events.essenciacompany.com/api/create-order",t,{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(w(),x({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"}),v()),I(!1)};return e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"payment-modal-backdrop payment-modal-fade-in"}),e.jsx("div",{className:`modal payment-modal ${a?"payment-modal-fade-in":"payment-modal-fade-out"}`,id:"scannerPaymentModal",tabIndex:"-1","aria-labelledby":"paymentModalLabel","aria-hidden":!a,onClick:v,children:e.jsx("div",{className:"modal-dialog modal-center modal-lg",onClick:t=>t.stopPropagation(),children:e.jsxs("div",{className:"modal-content p-0",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title text-center",id:"paymentModalLabel",children:"Place Order"}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:v})]}),e.jsxs("div",{className:"modal-body row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Payment Information"}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"nameInput",children:"Name"}),e.jsx("input",{id:"nameInput",name:"name",className:"form-control",value:d.name,onChange:g,placeholder:"Enter name"})]}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsxs("label",{htmlFor:"emailInput",children:["Email"," "]}),e.jsx("input",{id:"emailInput",className:"form-control",name:"email",value:d.email,onChange:g,placeholder:"Enter email"})]}),e.jsx(G,{value:d.phone,onChange:t=>x(u=>({...u,phone:"+"+t}))}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"vatInput",children:"VAT Number (optional)"}),e.jsx("input",{id:"vatInput",className:"form-control",name:"vatNumber",value:d.vatNumber,onChange:g,placeholder:"Enter VAT number"})]}),e.jsxs("div",{className:"form-group row mb-4",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{htmlFor:"discountInput",children:"Payment Method"}),e.jsxs("select",{class:"form-select","aria-label":"Default select example",onChange:t=>x(u=>({...u,paymentMethod:t.target.value})),children:[e.jsx("option",{value:"Cash",selected:!0,children:"Cash"}),e.jsx("option",{value:"Card",children:"Card"})]})]}),e.jsxs("div",{className:"col-md-8",children:[e.jsx("label",{htmlFor:"discountInput",children:"Discount"}),e.jsx("input",{id:"discountInput",type:"number",className:"form-control",name:"discount",value:d.discount>0?d.discount:"",onChange:g,placeholder:"Enter discount"})]})]}),e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",value:"",id:"flexCheckDefault",checked:p,onChange:()=>n(!p)}),e.jsx("label",{className:"form-check-label",for:"flexCheckDefault",children:"Withdraw"})]})]}),e.jsx("div",{className:"col-md-6",children:e.jsx(k,{items:l==null?void 0:l.extras,cartTotal:j,discount:d.discount})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:v,children:"Close"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:E,disabled:!d.name||(d.vatNumber?!(d.email||d.phone):!1)||S,children:S?"Processing...":"Proceed"})]})]})})})]})},ce=()=>{var O,$;const a=z.useRef(null),[c,l]=o.useState(null),[w,p]=o.useState(!1),[n,j]=o.useState(null),[d,x]=o.useState(""),[g,S]=o.useState(!1),[I,v]=o.useState(!1),[E,t]=o.useState(!1);o.useEffect(()=>{if(a.current&&!c){const s=new A(a.current,r=>{i(r)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(s)}return()=>{c&&(c.stop(),c.destroy(),l(null))}},[a.current,c]);const u=()=>{c?(p(!0),S(!0),c.start()):console.error("Scanner is not initialized yet")},i=async s=>{if(s!=null&&s.data)try{const r=await C.post("https://events.essenciacompany.com/api/tickets/get",{ticket:s==null?void 0:s.data});j(r.data)}catch(r){P("Error scanning ticket",r)}},y=s=>{s.key==="Enter"&&L()},L=async()=>{if(d){v(!1),p(!1);try{const s=await C.post("https://events.essenciacompany.com/api/tickets/get",{ticket:d});j(s.data),x("")}catch(s){P("Error scanning ticket",s)}finally{setIsProcessing(!1)}}},{data:N,isError:ee,isLoading:se,isSuccess:ne,refetch:ae}=Y(["scanner-extras",n],`https://events.essenciacompany.com/api/event-extras/${n==null?void 0:n.event_id}`),[F,_]=o.useState(!1),[f,D]=o.useState(null),[Q,q]=o.useState(1),B=()=>{var b;if(!F){_(!0);return}const s={...f,qty:0,newQty:Q};var r=!0,m=(b=n==null?void 0:n.extras)==null?void 0:b.map(h=>(console.log(h),h.id===s.id?(r=!1,{...h,newQty:parseInt(s.newQty)+parseInt((h==null?void 0:h.newQty)??(h==null?void 0:h.qty)??0)}):h));r&&(m=[...m,s]),j(h=>({...h,extras:[...m]})),_(!1),D(null),q(1)},[V,M]=o.useState(!1),X=async()=>{if(M(!0),(await C.post("https://events.essenciacompany.com/api/update-ticket",{ticket:n,can_withdraw:E},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(j(null),p(!1),P("Ticket updated successfully!!"),c)){c.stop();const r=new A(a.current,m=>{i(m)},{highlightScanRegion:!0,highlightCodeOutline:!0});l(r),r.start()}M(!1)},U=async()=>{var r;M(!0);const s=await C.post("https://events.essenciacompany.com/api/tickets/activate",{ticket:n==null?void 0:n.id},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}});s.status==200&&(j((r=s==null?void 0:s.data)==null?void 0:r.ticket),P("Ticket activated successfully!!")),M(!1)},[W,R]=o.useState(!1);return e.jsxs("section",{className:"scanner-page",children:[n?e.jsxs("div",{className:"ticket-info",children:[e.jsx("h3",{children:"Ticket Information"}),e.jsxs("div",{className:"ticket-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Owner:"})," ",n==null?void 0:n.owner.name]}),(n==null?void 0:n.owner.email)&&e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.owner.email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Event:"})," ",n==null?void 0:n.event_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ticket:"})," ",n==null?void 0:n.product_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Price:"})," €",n==null?void 0:n.price]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",(n==null?void 0:n.status)===0?"Not Used":"Used"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Dates:"})," ",n==null?void 0:n.dates.join(", ")]}),e.jsx("p",{children:e.jsxs("strong",{children:[(n==null?void 0:n.active)===0&&"Not ","Active",(n==null?void 0:n.active)===0&&e.jsx("span",{className:"btn btn-success ms-3 py-1 px-2",onClick:U,children:"Activate"})]})})]}),((O=n==null?void 0:n.extras)==null?void 0:O.length)>0?e.jsxs("div",{className:"extras",children:[e.jsx("h4",{children:"Extras"}),e.jsx("ul",{children:n==null?void 0:n.extras.map((s,r)=>{const m=parseInt((s==null?void 0:s.newQty)??0)?parseInt((s==null?void 0:s.newQty)??0):parseInt((s==null?void 0:s.qty)??0),b=parseFloat((s==null?void 0:s.price)??0).toFixed(2);return e.jsxs("span",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{className:"col-md-3 text-start",children:(s==null?void 0:s.display_name)??(s==null?void 0:s.name)}),e.jsxs("span",{className:"col-md-3 text-end",children:[m," X ",b,"€ ="]}),e.jsxs("span",{className:"col-md-3 text-end",children:[b*parseInt(s!=null&&s.newQty?(s==null?void 0:s.newQty)-(s==null?void 0:s.qty):0),"€"]})]},r)})})]}):null,F&&e.jsx("div",{className:"modal-body row",children:e.jsxs("div",{className:"col-md-12",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"extraSelect",children:"Select Extra"}),e.jsxs("select",{id:"extraSelect",className:"form-control mt-2",value:(f==null?void 0:f.display_name)||"",onChange:s=>{var m;const r=(m=N==null?void 0:N.data)==null?void 0:m.find(b=>b.display_name===s.target.value);D(r||null)},children:[e.jsx("option",{value:"",children:"None"}),($=N==null?void 0:N.data)==null?void 0:$.map((s,r)=>e.jsx("option",{value:s==null?void 0:s.display_name,children:s==null?void 0:s.display_name},r))]})]}),f&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group mt-3 d-flex flex-column justify-content-center align-items-center",children:[e.jsx("label",{htmlFor:"quantity",children:"Quantity"}),e.jsxs(H,{className:"w-50",children:[e.jsx(K,{variant:"outline-secondary",onClick:()=>q(s=>s-1>0?s-1:s),children:"-"}),e.jsx(J.Control,{"aria-label":"Example text with two button addons",className:"text-center",readOnly:!0,value:Q}),e.jsx(K,{variant:"outline-danger",onClick:()=>q(s=>s+1),children:"+"})]})]}),e.jsxs("label",{htmlFor:"price",children:["Price",e.jsx("br",{}),(f==null?void 0:f.price)*Q,"€"]})]})]})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-info text-light w-100 py-1",onClick:B,children:"Add extra"})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-success text-light w-100 py-1",onClick:()=>R(!0),children:V?"Processing...":"Save Changes"})})]}):w?"":e.jsxs("div",{className:"d-flex flex-column align-items-center gap-3",children:[e.jsxs("div",{className:"qr-box flex-column",onClick:u,children:[e.jsx("img",{className:"qr-image",src:"/assets/qr-code.png",alt:"QR Code"}),e.jsx("h3",{children:"start scanning"})]}),e.jsx("h3",{children:"or"}),e.jsx("input",{className:"qr-box flex-column",type:"text",onChange:s=>x(s.target.value),onKeyDown:y,placeholder:"Manually enter ticket code"})]}),!n&&e.jsxs("div",{children:[e.jsx("div",{id:"viewfinder",className:"qr-box",style:g?{}:{display:"none"},children:e.jsx("video",{ref:a,children:"Your browser does not support video playback."})}),e.jsx("div",{id:"manual-input",className:"form-group",style:I?{}:{display:"none"},children:e.jsx("input",{type:"text",name:"manual",className:"form-control",id:"manual",value:d,onChange:s=>x(s.target.value),onKeyDown:y,placeholder:"Enter ticket code manually"})})]}),e.jsx(T,{open:W,onClose:()=>R(!1),ticket:n,handleSubmit:X,withdraw:E,setWithdraw:t})]})};export{ce as default};
