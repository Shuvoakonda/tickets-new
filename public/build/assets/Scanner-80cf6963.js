import{r as c,j as e,m as w,R as U,B as I}from"./app-fde62002.js";import{e as O}from"./qr-scanner.min-089bcdda.js";import{a as z,I as G,B as $,F as Y}from"./CartInfo-1f121bfe.js";import"./index-1f2dfe27.js";function H({item:a}){const o=c.useMemo(()=>((a==null?void 0:a.newQty)??0)-((a==null?void 0:a.qty)??0),[a==null?void 0:a.newQty,a==null?void 0:a.qty]);return e.jsx(e.Fragment,{children:e.jsxs("tr",{className:"table-info",children:[e.jsx("td",{children:(a==null?void 0:a.display_name)??(a==null?void 0:a.name)}),e.jsxs("td",{children:[a==null?void 0:a.price," €"]}),e.jsx("td",{children:o}),e.jsxs("td",{children:[(a==null?void 0:a.price)*o," €"]})]})})}function J({items:a=[],cartTotal:o=0,discount:t=0}){const N=c.useMemo(()=>o-t,[o,t]);return e.jsxs("div",{className:"h-100 d-flex flex-column justify-content-start",children:[e.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Cart Information"}),e.jsx("div",{className:"cart-info-items-container",children:e.jsx("div",{className:"card",children:e.jsxs("table",{className:"table mb-0 rounded",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Total"})]})}),e.jsx("tbody",{children:a==null?void 0:a.map((u,n)=>e.jsx(H,{item:u},n))})]})})}),e.jsx("div",{className:"card mt-auto",children:e.jsx("table",{className:"table mb-0",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{children:"Subtotal"}),e.jsxs("td",{children:[o," €"]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Discount"}),e.jsxs("td",{children:[t," €"]})]}),e.jsxs("tr",{children:[e.jsx("td",{children:"Total"}),e.jsxs("td",{children:[N," €"]})]})]})})})]})}const W=({open:a,onClose:o,ticket:t,handleSubmit:N})=>{const u=c.useMemo(()=>{var j;var r=0;return(j=t==null?void 0:t.extras)==null||j.map(d=>{(d==null?void 0:d.newQty)>0&&(r+=((d==null?void 0:d.newQty)-d.qty)*d.price)}),r},[t==null?void 0:t.extras]),[n,m]=c.useState({name:"",email:"",vatNumber:"",discount:0,paymentMethod:"Cash"}),p=r=>{const{name:j,value:d}=r.target;m(x=>({...x,[j]:d}))},[b,S]=c.useState(!1);c.useEffect(()=>{const r=document.getElementById("scannerPaymentModal");a?(r.classList.add("show","fade-in"),r.style.display="block"):(r.classList.remove("fade-in"),r.classList.add("fade-out"),setTimeout(()=>{r.style.display="none",r.classList.remove("show","fade-out")},300))},[a]);const v=()=>o(),E=async()=>{var d;S(!0);const r={biling:n,tickets:[],extras:(d=t==null?void 0:t.extras)==null?void 0:d.map(x=>{if(x.newQty>0)return{...x,quantity:x.newQty-x.qty}}),discount:n.discount,paymentMethod:n.paymentMethod,subTotal:u,total:u};(await w.post("https://events.essenciacompany.com/api/create-order",r,{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(N(),m({name:"",email:"",phone:"",vatNumber:"",discount:0,paymentMethod:"Cash"}),v()),S(!1)};return e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"payment-modal-backdrop payment-modal-fade-in"}),e.jsx("div",{className:`modal payment-modal ${a?"payment-modal-fade-in":"payment-modal-fade-out"}`,id:"scannerPaymentModal",tabIndex:"-1","aria-labelledby":"paymentModalLabel","aria-hidden":!a,onClick:v,children:e.jsx("div",{className:"modal-dialog modal-center modal-lg",onClick:r=>r.stopPropagation(),children:e.jsxs("div",{className:"modal-content p-0",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h5",{className:"modal-title text-center",id:"paymentModalLabel",children:"Place Order"}),e.jsx("button",{type:"button",className:"btn-close","aria-label":"Close",onClick:v})]}),e.jsxs("div",{className:"modal-body row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsx("h5",{className:"modal-title text-start mb-2",id:"paymentModalLabel",children:"Payment Information"}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"nameInput",children:"Name"}),e.jsx("input",{id:"nameInput",name:"name",className:"form-control",value:n.name,onChange:p,placeholder:"Enter name"})]}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsxs("label",{htmlFor:"emailInput",children:["Email"," "]}),e.jsx("input",{id:"emailInput",className:"form-control",name:"email",value:n.email,onChange:p,placeholder:"Enter email"})]}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"emailInput",children:"Phone"}),e.jsx("input",{id:"emailInput",className:"form-control",name:"phone",value:n.phone,onChange:p,placeholder:"Enter phone"})]}),e.jsxs("div",{className:"form-group mb-2",children:[e.jsx("label",{htmlFor:"vatInput",children:"VAT Number (optional)"}),e.jsx("input",{id:"vatInput",className:"form-control",name:"vatNumber",value:n.vatNumber,onChange:p,placeholder:"Enter VAT number"})]}),e.jsxs("div",{className:"form-group row mb-4",children:[e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{htmlFor:"discountInput",children:"Payment Method"}),e.jsxs("select",{class:"form-select","aria-label":"Default select example",onChange:r=>m(j=>({...j,paymentMethod:r.target.value})),children:[e.jsx("option",{value:"Cash",selected:!0,children:"Cash"}),e.jsx("option",{value:"Card",children:"Card"})]})]}),e.jsxs("div",{className:"col-md-8",children:[e.jsx("label",{htmlFor:"discountInput",children:"Discount"}),e.jsx("input",{id:"discountInput",type:"number",className:"form-control",name:"discount",value:n.discount>0?n.discount:"",onChange:p,placeholder:"Enter discount"})]})]})]}),e.jsx("div",{className:"col-md-6",children:e.jsx(J,{items:t==null?void 0:t.extras,cartTotal:u,discount:n.discount})})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:v,children:"Close"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:E,disabled:!n.name||(n.vatNumber?!(n.email||n.phone):!1)||b,children:b?"Processing...":"Proceed"})]})]})})})]})},le=()=>{var D,R;const a=U.useRef(null),[o,t]=c.useState(null),[N,u]=c.useState(!1),[n,m]=c.useState(null),[p,b]=c.useState(""),[S,v]=c.useState(!1),[E,r]=c.useState(!1);c.useEffect(()=>{if(a.current&&!o){const s=new O(a.current,l=>{d(l)},{highlightScanRegion:!0,highlightCodeOutline:!0});t(s)}return()=>{o&&(o.stop(),o.destroy(),t(null))}},[a.current,o]);const j=()=>{o?(u(!0),v(!0),o.start()):console.error("Scanner is not initialized yet")},d=async s=>{if(s!=null&&s.data)try{const l=await w.post("https://events.essenciacompany.com/api/tickets/get",{ticket:s==null?void 0:s.data});m(l.data)}catch(l){I("Error scanning ticket",l)}},x=s=>{s.key==="Enter"&&A()},A=async()=>{if(p){r(!1),u(!1);try{const s=await w.post("https://events.essenciacompany.com/api/tickets/get",{ticket:p});m(s.data),b("")}catch(s){I("Error scanning ticket",s)}finally{setIsProcessing(!1)}}},{data:g,isError:Z,isLoading:k,isSuccess:T,refetch:ee}=z(["scanner-extras",n],`https://events.essenciacompany.com/api/event-extras/${n==null?void 0:n.event_id}`),[q,F]=c.useState(!1),[y,Q]=c.useState(null),[M,P]=c.useState(1),K=()=>{var f;if(!q){F(!0);return}const s={...y,qty:0,newQty:M};var l=!0,h=(f=n==null?void 0:n.extras)==null?void 0:f.map(i=>i.id===s.id?(l=!1,{...i,newQty:parseInt(s.newQty)+parseInt((i==null?void 0:i.newQty)??(i==null?void 0:i.qty)??0)}):i);l&&(h=[...h,s]),m(i=>({...i,extras:[...h]})),F(!1),Q(null),P(1)},[L,C]=c.useState(!1),B=async()=>{if(C(!0),(await w.post("https://events.essenciacompany.com/api/update-ticket",{ticket:n},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}})).status==200&&(m(null),u(!1),I("Ticket updated successfully!!"),o)){o.stop();const l=new O(a.current,h=>{d(h)},{highlightScanRegion:!0,highlightCodeOutline:!0});t(l),l.start()}C(!1)},V=async()=>{var l;C(!0);const s=await w.post("https://events.essenciacompany.com/api/tickets/activate",{ticket:n==null?void 0:n.id},{headers:{"Content-Type":"application/json","X-Secret-Key":"pos_password"}});s.status==200&&(m((l=s==null?void 0:s.data)==null?void 0:l.ticket),I("Ticket activated successfully!!")),C(!1)},[X,_]=c.useState(!1);return e.jsxs("section",{className:"scanner-page",children:[n?e.jsxs("div",{className:"ticket-info",children:[e.jsx("h3",{children:"Ticket Information"}),e.jsxs("div",{className:"ticket-details",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Owner:"})," ",n==null?void 0:n.owner.name]}),(n==null?void 0:n.owner.email)&&e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.owner.email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Event:"})," ",n==null?void 0:n.event_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ticket:"})," ",n==null?void 0:n.product_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Price:"})," €",n==null?void 0:n.price]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",(n==null?void 0:n.status)===0?"Not Used":"Used"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Dates:"})," ",n==null?void 0:n.dates.join(", ")]}),e.jsx("p",{children:e.jsxs("strong",{children:[(n==null?void 0:n.active)===0&&"Not ","Active",(n==null?void 0:n.active)===0&&e.jsx("span",{className:"btn btn-success ms-3 py-1 px-2",onClick:V,children:"Activate"})]})})]}),((D=n==null?void 0:n.extras)==null?void 0:D.length)>0?e.jsxs("div",{className:"extras",children:[e.jsx("h4",{children:"Extras"}),e.jsx("ul",{children:n==null?void 0:n.extras.map((s,l)=>{if(!(s!=null&&s.newQty))return"";const h=parseInt((s==null?void 0:s.newQty)??0)-parseInt((s==null?void 0:s.qty)??0),f=parseFloat((s==null?void 0:s.price)??0).toFixed(2);return e.jsxs("span",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{className:"col-md-3 text-start",children:(s==null?void 0:s.display_name)??(s==null?void 0:s.name)}),e.jsxs("span",{className:"col-md-3 text-end",children:[h," X ",f,"€ ="]}),e.jsxs("span",{className:"col-md-3 text-end",children:[f*parseInt(s!=null&&s.newQty?(s==null?void 0:s.newQty)-(s==null?void 0:s.qty):0),"€"]})]},l)})})]}):null,q&&e.jsx("div",{className:"modal-body row",children:e.jsxs("div",{className:"col-md-12",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"extraSelect",children:"Select Extra"}),e.jsxs("select",{id:"extraSelect",className:"form-control mt-2",value:(y==null?void 0:y.display_name)||"",onChange:s=>{var h;const l=(h=g==null?void 0:g.data)==null?void 0:h.find(f=>f.display_name===s.target.value);Q(l||null)},children:[e.jsx("option",{value:"",children:"None"}),(R=g==null?void 0:g.data)==null?void 0:R.map((s,l)=>e.jsx("option",{value:s==null?void 0:s.display_name,children:s==null?void 0:s.display_name},l))]})]}),y&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group mt-3 d-flex flex-column justify-content-center align-items-center",children:[e.jsx("label",{htmlFor:"quantity",children:"Quantity"}),e.jsxs(G,{className:"w-50",children:[e.jsx($,{variant:"outline-secondary",onClick:()=>P(s=>s-1>0?s-1:s),children:"-"}),e.jsx(Y.Control,{"aria-label":"Example text with two button addons",className:"text-center",readOnly:!0,value:M}),e.jsx($,{variant:"outline-danger",onClick:()=>P(s=>s+1),children:"+"})]})]}),e.jsxs("label",{htmlFor:"price",children:["Price",e.jsx("br",{}),(y==null?void 0:y.price)*M,"€"]})]})]})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-info text-light w-100 py-1",onClick:K,children:"Add extra"})}),e.jsx("span",{className:"d-flex justify-content-center align-items-center mt-2",children:e.jsx("button",{type:"button",class:"btn btn-success text-light w-100 py-1",onClick:()=>_(!0),children:L?"Processing...":"Save Changes"})})]}):N?"":e.jsxs("div",{className:"d-flex flex-column align-items-center gap-3",children:[e.jsxs("div",{className:"qr-box flex-column",onClick:j,children:[e.jsx("img",{className:"qr-image",src:"/assets/qr-code.png",alt:"QR Code"}),e.jsx("h3",{children:"start scanning"})]}),e.jsx("h3",{children:"or"}),e.jsx("input",{className:"qr-box flex-column",type:"text",onChange:s=>b(s.target.value),onKeyDown:x,placeholder:"Manually enter ticket code"})]}),!n&&e.jsxs("div",{children:[e.jsx("div",{id:"viewfinder",className:"qr-box",style:S?{}:{display:"none"},children:e.jsx("video",{ref:a,children:"Your browser does not support video playback."})}),e.jsx("div",{id:"manual-input",className:"form-group",style:E?{}:{display:"none"},children:e.jsx("input",{type:"text",name:"manual",className:"form-control",id:"manual",value:p,onChange:s=>b(s.target.value),onKeyDown:x,placeholder:"Enter ticket code manually"})})]}),e.jsx(W,{open:X,onClose:()=>_(!1),ticket:n,handleSubmit:B})]})};export{le as default};
